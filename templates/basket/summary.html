{% extends 'base.html' %}
{% load static %}
{% load product_filter %}

{% block title %}
Basket summary
{% endblock title %}

{% block stylesheet %}
{% static 'store/css/store.css' %}
{% endblock %}

{% block content %}

<div class="container">
    <div class="col-12">
        <h1 class="h2">Your Basket</h1>
    </div>
    <div class="col-12">
        <p>Manage your <b>items</b> in your basket</p>
    </div>
    <hr />
</div>
<div class="container" style="max-width: 1000px">
    <div class="row g-3">
        {% if basket|length == 0 %}
        <div class="col-12">Your basket is empty
            <a href="{% url 'store:store_home' %}">
                Shop
            </a>
        </div>
        {% else %}
        <div class="col-12 bg-light p-3 d-flex justify-content-between">
            <div class="d-flex d-flex-inline">
                <div class="pe-3">Order Id</div>
            </div>
            <div class="col-md-5 col-lg-4 order-md-last p-0 order-3">
                <div class="d-grid gap-2 ">
                    <a role="button" href="{% url 'checkout:deliverychoices' %}" class="btn btn-success fw-bold"
                        type="button">Checkout Securely</a>
                    <button class="btn btn-light" type="button">Save for later</button>
                </div>
            </div>
            <div class="text-end">

                <div class="">Sub Total: <span class="fw-bold">£</span>
                    <div id="subtotal" class="d-inline-flex fw-bold">{{basket.get_total_price}}</div>
                </div>

                <div class="pt-2">Total to pay: <span class="fw-bold h5">£</span>
                    <div id="total-to-pay" class="d-inline-flex fw-bold h5">{{basket.get_total_price}}</div>
                </div>
            </div>
        </div>
        <div class="col-md-7 col-lg-8 p-0">
            {% for item in basket %}
            {% with product=item.product %}
            <div class="card mb-3 border-0 product-item" data-index="{{product.id}}">
                <div class="row g-0">
                    <div class="col-md-2 d-none d-md-block">
                        <img class="img-fluid mx-auto d-block" alt="Responsive image" src="{{ product.image.url }}" />
                    </div>
                    <div class="col-md-10 ps-md-3">
                        <div class="card-body p-1">
                            <a class="text-decoration-none text-reset" href="{{item.product.get_absolute_url}}">
                                <p class="card-text pb-3">{{product.title}}</p>
                            </a>
                            {% with pid=product.id %}
                            {% if product.inventory == 0 %}
                            <label for="select">Out of Stock!</label>

                            {% elif product.inventory > 5 %}

                            <label for="select">Qty</label>
                            <select id="select{{product.id}}" style="width:50px;height:31px;">
                                {% for value in basket_range_dict|getbykey:pid %}
                                <option value="" selected disabled hidden>{{item.qty}}</option>
                                <option value="{{value}}">{{value}}</option>
                                {% endfor %}
                            </select>

                            {% else %}

                            <label for="select">Qty</label>
                            <select id="select{{product.id}}" style="width:50px;height:31px;">
                                {% for value in basket_range_dict|getbykey:pid %}
                                <option value="" selected disabled hidden>{{item.qty}}</option>
                                <option value="{{value}}">{{value}}</option>
                                {% endfor %}
                            </select>
                            {% endif %}
                            {% endwith %}
                            {% if product.inventory == 0 %}
                            <a type="button" id="update-button" data-index="{{product.id}}"
                                class="isDisabled text-decoration-none small ps-3">Update</a>
                            {% else %}
                            <a type="button" id="update-button" data-index="{{product.id}}"
                                class="update-button text-decoration-none small ps-3">Update</a>
                            {% endif %}

                            <a type="button" id="delete-button" data-index="{{product.id}}"
                                class="delete-button text-decoration-none small">Delete</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>


<script>
    $(document).on('click', '.delete-button', function (e) {
        e.preventDefault();
        var prodid = $(this).data('index');
        console.log($('#select option:selected').text())
        $.ajax({
            type: 'POST',
            url: '{% url "basket:basket_delete" %}',
            data: {
                productid: $(this).data('index'),
                csrfmiddlewaretoken: "{{ csrf_token }}",
                action: 'post'
            },
            success: function (json) {
                $('.product-item[data-index="' + prodid + '"]').remove()
                document.getElementById("basket-qty").innerHTML = json.qty
                document.getElementById("subtotal").innerHTML = json.subtotal
                document.getElementById("total-to-pay").innerHTML = json.subtotal
            },
            error: function (xhr, errmsg, err) {

            }
        });

    })

    $(document).on('click', '.update-button', function (e) {
        e.preventDefault();
        var prodid = $(this).data('index');
        console.log($('#select option:selected').text())
        $.ajax({
            type: 'POST',
            url: '{% url "basket:basket_update" %}',
            data: {
                productid: $(this).data('index'),
                productqty: $('#select' + prodid + ' option:selected').text(),
                csrfmiddlewaretoken: "{{ csrf_token }}",
                action: 'post'
            },
            success: function (json) {
                document.getElementById("basket-qty").innerHTML = json.qty
                document.getElementById("subtotal").innerHTML = json.subtotal
                document.getElementById("total-to-pay").innerHTML = json.subtotal
            },
            error: function (xhr, errmsg, err) {

            }
        });

    })
</script>
{% endblock content %}